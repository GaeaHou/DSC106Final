<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Glucose Visualization</title>
  <link rel="stylesheet" href="glucose.css">
  <link rel="icon" href="data/image.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
  
  <style>
    .hidden { display: none; }
    .fade-out { opacity: 0; transition: opacity 0.8s ease; }
    .fade-in { opacity: 1; transition: opacity 0.8s ease; }

    @keyframes fadeInHint {
      to { opacity: 1; }
    }

    @keyframes blinkCursor {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .slide-in-button {
      margin-top: 2rem;
      padding: 0.8rem 1.6rem;
      font-size: 1.1rem;
      font-weight: bold;
      background-color: #66BB6A;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.6s ease;
    }

    .slide-in-button.visible {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="container" id="main-container">

    <div class="title-wrapper">
      <h1 class="main-title">How does glucose change throughout the day?</h1>
      <div class="subtitle">Visualizing glucose patterns across meals and time</div>
    </div>

    <div class="two-column-layout">
      <div class="column left-column">
        <div class="control-card">
          <div class="controls-horizontal">
            <div class="control-group">
              <label for="person-select">Person:</label>
              <select id="person-select"></select>
            </div>
            <div class="control-group">
              <label for="date-select">Date:</label>
              <select id="date-select"></select>
            </div>
            <div class="control-group">
              <label>&nbsp;</label>
              <button id="reset-view">üîÑ Reset View</button>
            </div>
          </div>
          <div class="control-legend">
            <span class="dot blue-dot"></span> Glucose Point
            <span class="dot red-dot"></span> Meal Indicator
          </div>
        </div>
        <div class="instruction-card">
          <div class="instruction">
            <p>This dashboard shows daily glucose levels recorded by continuous monitors. Each blue dot represents a glucose reading at a specific time, while red dots indicate readings recorded shortly after a meal.</p>
            <p>Hover over any point to view the exact time and glucose value. You can also zoom in by selecting a time range on the chart, and reset at any time.</p>
            <p>Look closely at the red dots. <b>What happens to glucose levels after meals? Do they always rise? Are the patterns the same for every meal‚Äîor every person?</b></p>
            <p>This tool is designed to help you explore those patterns. Try switching between different people and days. See if you can spot trends in how glucose behaves after breakfast, lunch, or dinner.</p>
            <img src="./data/intro.png" style="display: block; margin: 12px auto; max-width: 100%;" />
          </div>
        </div>
      </div>

      <div class="column right-column">
        <div id="chart"></div>
      </div>
    </div>
    <div class="title-wrapper2">
      <h1 class="main-title2">How does nutrition shape your glucose curve?</h1>
      <div class="subtitle2">Predicting blood sugar trends based on food composition</div>
    </div>
  <!-- glucose prediction section -->
  <div class="two-column-layout2">
    <!-- Â∑¶ËæπÔºöÊ®°ÊãüÂõæ -->
    <div class="column left-column2">
      <svg id="glucose-plot" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
    <!-- Âè≥ËæπÔºöËæìÂÖ•Ë°®Âçï + story -->
    <div class="column right-column2">
      <div class="control-card2">
        <form id="input-form" class="two-col-form">
          <label><span>Calorie:</span> <input type="number" id="calorie" value="410"></label>
          <label><span>Total Carbohydrates:</span> <input type="number" id="total_carb" value="83"></label>
          <label><span>Sugar:</span> <input type="number" id="sugar" value="66"></label>
          <label><span>Protein:</span> <input type="number" id="protein" value="13"></label>
          <label><span>Total Fat:</span> <input type="number" id="total_fat" value="0"></label>
          <label><span>Dietary Fiber:</span> <input type="number" id="dietary_fiber" value="0"></label>
          <label><span>HbA1c:</span> <input type="number" id="hba1c" value="5.6" step="0.1"></label>
          <label><span>Initial Glucose:</span> <input type="number" id="init_val" value="138" step="1"></label>
          <label><span>Gender:</span>
            <select id="gender">
              <option value="MALE">MALE</option>
              <option value="FEMALE">FEMALE</option>
            </select>
          </label>
          <button type="button" id="predict-button">Predict</button>
        </form>
      </div>

      <!-- È¢ÑÁïôÔºöstory ÂèØËßÜÂåñËß£ÈáäÈÉ®ÂàÜ -->
      <div class="instruction-card">
        <div class="instruction2">
          <p>
            While everyone experiences blood sugar changes throughout the day, the <b>exact shape of your glucose curve depends heavily on what you eat</b>.
          </p>
          
          <p>
            This visualization lets you explore how different nutritional components‚Äîlike carbohydrates, sugar, protein, and fat‚Äîaffect your blood glucose trends after a meal.
          </p>
          
          <p>
            For example, suppose <b>Alice</b> just had a meal that included:
            <ul>
              <li>üçö <b>White rice</b> ‚Äì high in carbohydrates and sugar</li>
              <li>üçó <b>Grilled chicken</b> ‚Äì rich in protein</li>
              <li>üçé <b>Apple</b> ‚Äì contains sugar and fiber</li>
            </ul>
            We can input the approximate nutritional values: 410 kcal, 83g total carbs, 66g sugar, 13g protein, and minimal fat and fiber.
          </p>
          
          <p>
            Try adjusting these values in the panel to the right. Watch how the <b>glucose prediction curve</b> changes in real-time.
          </p>
          
          <p>
            <b>Can you predict how adding more fiber or reducing sugar would change the shape?</b> Try it and see!
          </p>
        </div>
      </div>
      
    </div>
  </div>
  </div>

  <!-- tooltip -->
  <div id="tooltip" class="tooltip"></div>

  <!-- ÊªöÂä®ÊèêÁ§∫ -->
  <div id="click-anywhere-tip" class="continue-hint hidden">
    Click anywhere to continue
  </div>

  <!-- Âä®ÁîªËøáÊ∏°Âú∫ÊôØ -->
  <section class="fullscreen-scene hidden" id="next-scene">
    <div class="next-scene-content glass-box">
    <div id="typed-container"></div>
    <button id="show-trend-btn" class="slide-in-button hidden">‚Üí Explore Group Trends</button>
  </div>
  </section>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="./js/script.js"></script>
  <script src="js/model.js"></script>
  <script>
    // ÊªöÂä®Ê£ÄÊµã
    window.addEventListener('scroll', () => {
      const tip = document.getElementById('click-anywhere-tip');
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
        tip.classList.remove('hidden');
      }
    });
  
    // ÁÇπÂáªÁªßÁª≠
    document.addEventListener('click', (e) => {
  const container = document.getElementById('main-container');
  const isInsideContainer = container.contains(e.target);

  const isButton = e.target.tagName === 'BUTTON' || e.target.closest('button');

  // Âè™ÊúâÁÇπÂáªÂú® container Â§ñÈÉ®‰∏î‰∏çÊòØÊåâÈíÆÊó∂ÊâçËß¶Âèë
  if (!isInsideContainer && !isButton) {
    transitionToTypingScene();
  }
});
  
    function transitionToTypingScene() {
      document.querySelector('.container').classList.add('fade-out');
      document.getElementById('click-anywhere-tip').classList.add('fade-out');
  
      setTimeout(() => {
        document.querySelector('.container').style.display = 'none';
        document.getElementById('click-anywhere-tip').style.display = 'none';
        const scene = document.getElementById('next-scene');
        scene.classList.remove('hidden');
        scene.classList.add('fade-in');
        startTypingSequence();
      }, 800);
    }
  
    // ‚úÖ Âè∞ËØçÂä®ÁîªÔºöÊõøÊç¢‰∏∫‰Ω†Êèê‰æõÁöÑÂõõÂè•ÂØπÁôΩ
    function startTypingSequence() {
      console.log("üü¢ startTypingSequence() triggered");
      const lines = [
        "We‚Äôve seen how glucose levels rise and fall throughout the day,",
        "and how those patterns vary from person to person and meal to meal.",
        "So what happens when we zoom out and look at many people at once?",
        "Let‚Äôs explore the broader patterns hidden in group glucose data..."
      ];
      const container = document.getElementById('typed-container');
      let lineIndex = 0;
  
      function typeLine(line, callback) {
        const lineWrapper = document.createElement('div');
        lineWrapper.className = 'dialogue-line';
  
        const textSpan = document.createElement('span');
        textSpan.className = 'dialogue-text typing';
        lineWrapper.appendChild(textSpan);
        container.appendChild(lineWrapper);
  
        let i = 0;
        const interval = setInterval(() => {
          if (i < line.length) {
            textSpan.textContent = line.substring(0, i + 1);
            i++;
          } else {
            clearInterval(interval);
            textSpan.classList.remove('typing');
            setTimeout(callback, 800);
          }
        }, 40);
      }
  
      function showNextLine() {
        if (lineIndex < lines.length) {
          typeLine(lines[lineIndex], () => {
            lineIndex++;
            showNextLine();
          });
        } else {
          setTimeout(() => {
            const btn = document.getElementById('show-trend-btn');
            btn.classList.remove('hidden');
            btn.classList.add('visible');
            btn.onclick = () => {
              window.location.href = './part5.html';
            };
          }, 1000);
        }
      }
  
      showNextLine();
    }
  </script>
</body>
</html>